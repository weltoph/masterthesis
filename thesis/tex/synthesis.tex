\chapter{Synthesis}
\label{chapter:synthesis}
For the general synthesis question we refer to \cite{Church} and formalize it
as
\begin{definition}[Synthesis Question]
  Given a logical specification  $\varphi(\cdot, \cdot)$ over inputs and 
  outputs from $I^{\omega}$ and $J^{\omega}$ respectively. The synthesis 
  problem requires to compute for any such $\varphi$ an algorithm 
  $S:I^{+}\rightarrow J$ such that for every 
  $\alpha_{1}\alpha_{2}\dots\in I^{\omega}$ and every 
  $S(\alpha) = S(\alpha_{1})S(\alpha_{1}\alpha_{2})\dots$ satisfies 
  $\varphi(I, S(I))$ or prove that such an $S$ cannot exist.
\end{definition}
Naturally, the complexity of this problem is tightly related to the 
expressibility of $\varphi$. The comprehensive demand of this question, namely
to generate for all inputs an associated \enquote{good} output, allows for a
game-theoretic formulation. As suggested in \cite{SeqCondStrat} we can consider
the environment as antagonistic and formulate the synthesis question in terms
of strategies, i.e. one player generates inputs while another player generates
outputs. The output-player wins if and only if $\varphi$ is satisfied for the
input- and outputsequences. In the following we present known synthesis results 
for those $\varphi$ which allow to capture the associated relation as 
$\omega$-regular language. Subsequently, we pivot towards probabilistic 
environments and review an approach to synthesis algorithms there which are not
necessarily completely correct but almost-surely satisfy a specification 
$\varphi$. At last, we examine probabilistic environments which are modelled as
\acp{POMDP}.

\subsection{$\omega$-regular Languages}


\section{Strategy Synthesis for \ac{POMDP}}
\subsection{Probabilistic BÃ¼chi Automata}
The synthesis for \acp{PBA} is - in our current context - understood as the
following question:
\begin{definition}[PBA-Synthesis Question]
  Given a \ac{POMDP} $\mathcal{M}$ and a \ac{PBA} $\mathcal{P}$ with
  \begin{equation*}
    \mathcal{M} = \tuple{S, s_{0}, A, \tuple{\tau_{a}}_{a\in A}, \sim}
  \text{ and }
    \mathcal{P} = \tuple{Q, q_{0}, S, \delta, F}
  \end{equation*}
  exists a strategy $s:\interval{S}_{\sim}^{*}\rightarrow A$ such that 
  almost-all executions of $\mathcal{A}$ under $s$ are accepted by 
  $\mathcal{P}$?
  \label{def:synthesis}
\end{definition}
Considering a qualitative acceptance condition on $\mathcal{P}$ we can answer
this question positively with
\begin{theorem}[Qualitative PBA Synthesis]
  The synthesis question of an environment $\mathcal{M}$ and a specification
  provided as \ac{PBA} $\mathcal{A}$ with a qualitative acceptance measure
  can be decided.
  \label{thm:pbasynthesis}
\end{theorem}

Considering a certain restricted class of \acp{MDP}, namely those where for 
every state ever following state is defined by a probability distribution $B$
(regardless of the action chosen by the player), then this result can be 
derived as a corollary from the construction examined in Example 
\ref{ex:pwapbaallpaths}. Although the following construction bears structural
similarities with the one presented there, the arguments used here are a little 
more involved.

\begin{proof}
  We fix one strategy $s:\interval{S}_{\sim}^{*}\rightarrow A$ which induces a 
  probability space
  \begin{equation*}
    \tuple{S^{\omega},\mathcal{B}(S), \mu_{s}}.
  \end{equation*}
  Furthermore, for any given $\alpha\in S^{\omega}$ the stochastic process of
  $\mathcal{P}$ also yields a probability space
  \begin{equation*}
    \tuple{Q^{\omega},\mathcal{B}(Q), \mu_{\alpha}}.
  \end{equation*}
  The analytical complexity is rooted in the dependency of $\mu_{\alpha}$ from
  $\alpha$. We approach this dependency in terms of \emph{Markov-kernels}. We
  define (analogously to \cite[Definition 8.25]{Klenke})
  \begin{definition}[Markov-Kernel]
    For two measurable spaces $\tuple{\Omega_{1},\mathcal{F}_{1}}$ and 
    $\tuple{\Omega_{2},\mathcal{F}_{2}}$ a function
    \begin{equation*}
      K:\Omega_{1}\times\mathcal{F}_{2}\rightarrow\interval{0,1}
    \end{equation*}
    is called a Markov-kernel if
    \begin{enumerate}
      \item $K(\cdot, A)$ is measurable in $\mathcal{F_{1}}$ for all 
        $A\in\mathcal{F}_{2}$,
      \item $K(\omega, \cdot)$ is a probability measure on 
        $\tuple{\Omega_{2},\mathcal{F}_{2}}$ for every $\omega\in\Omega_{1}$.
    \end{enumerate}
  \end{definition}
  We define the following Markov-kernel
  \begin{equation*}
    K:S^{\omega}\times\mathcal{B}(Q)\rightarrow\interval{0,1}\text{ with }
      K(\alpha, A) = \mu_{\alpha}(A)
  \end{equation*}
  for the measurable spaces $\tuple{S^{\omega},\mathcal{B}(S)}$ and 
  $\tuple{Q^{\omega},\mathcal{B}(Q)}$. The central inside arises from Lemma 
  \ref{lem:almosteverywhere} which allows us to state
  \begin{equation*}
    \int_{S^{\omega}}K(\cdot, \Acc(F)) d\mu_{s} 
    = \int_{\alpha\in S^{\omega}}\mu_{\alpha}(\Acc(F))d\mu_{s} = 1 \text{ iff }
      \mu_{s}(K(\cdot,\Acc(F))^{-1}(1)) = 1.
  \end{equation*}
  This characterises the synthesis question from Definition \ref{def:synthesis}
  since $\mu_{s}(K(\cdot,\Acc(F))^{-1}(1))$ is the set of executions which are
  accepted by an almost-sure measure by $\mathcal{P}$. Notably, we can assure 
  this statement only under the premise that $K(\cdot, \Acc(F))$ is indeed 
  measurable. This is a direct consequence if $K$ is a Markov-kernel since 
  $\Acc(F)\in\mathcal{B}(Q)$. We address this condition with the following
  \begin{lemma}
    $K$ as defined above is a Markov-kernel.
  \end{lemma}
  \begin{proof}
    With $K(\alpha,\cdot) = \mu_{\alpha}$ it is trivial to state that 
    $K(\alpha,\cdot)$ defines a probability measure for 
    $\tuple{Q^{\omega},\mathcal{B}(Q)}$.

    We refer to \cite[Remark 8.26]{Klenke} to justify that we only check the 
    second condition for cylindric $A\in\mathcal{B}(Q)$, i.e. $A = \cyl(u)$ for 
    some $u\in Q^{*}$. Fundamentally, we observe that by definition of the 
    transition probabilities for a \ac{PBA} we obtain for any $u\in S^{n}$ and 
    $\alpha, \beta\in\cyl(u)$ that
    \begin{equation*}
      \mu_{\alpha}(\cyl(v)) = \mu_{\beta}(\cyl(v))\text{ for all }v\in Q^{n}.
    \end{equation*}
    This justifies the use of the notion $\mu_{u}$.
    By \cite[Theorem 9.2]{Bauer} the measurability of $K(\cdot, \cyl(u))$ is
    implied if for all $a\in\mathbb{R}$
    \begin{equation*}
      \set{\alpha\in S^{\omega}\mid K(\alpha, \cyl(v))\leq a}\in\mathcal{B}(S).
    \end{equation*}
    Observably,
    \begin{equation*}
      \set{\alpha\in S^{\omega}\mid K(\alpha, \cyl(v))\leq a} = 
        \bigcup\set{
          \cyl(u):u\in S^{\size{v}}\text{ and }\mu_{u}(\cyl(v))\leq a
        }
    \end{equation*}
    implies the necessary membership in $\mathcal{B}(S)$ since $S^{\size{v}}$ 
    is finite.
  \end{proof}
  Having this Markov-kernel $K$ allows us to use the following
  \begin{theorem}
    \cite[Korollar 14.23]{Klenke}
    For a probability space $\tuple{\Omega_{1}, \mathcal{F}_{1}, \mu}$, a
    measurable space $\tuple{\Omega_{2}, \mathcal{F}_{2}}$ and a Markov-kernel
    $K:\Omega_{1}\times\mathcal{F}_{2}$ there exists a unique probability 
    measure $\mu\otimes K$ on $\tuple{\Omega_{1}\times \Omega_{2}, 
    \mathcal{F}_{1}\times\mathcal{F}_{2}}$ with
    \begin{equation*}
      \mu\otimes K(A_{1}, A_{2}) = \int_{A_{1}} K(\omega, A_{2})d\mu
      \text{ for all }A_{1}\in\mathcal{F}_{1}, A_{2}\in\mathcal{F}_{2}.
    \end{equation*}
  \end{theorem}
  
  We proceed in defining an appropiate \ac{WDTA} to capture precisely those 
  strategies which satisfy the synthesis requirement. The concept mirrors the
  resulting \ac{WDTA} when we combine the path measure and the run measure for
  \acp{PWA} (see Example \ref{ex:pwapbaallpaths}) by build run-trees of a 
  \ac{PBA} along the executions. But it is actually not necessary to restrict
  ourselves to one execution step of the \ac{PBA} per direction. This 
  observation is essential for formulating this result for \acp{POMDP} rather 
  than for \acp{MDP} alone.
  \begin{definition}[Synthesis WDTA]
    For a \ac{POMDP} $\mathcal{M}$ and a \ac{PBA} $\mathcal{P}$ with
    \begin{equation*}
      \mathcal{M} = \tuple{S, A, \tuple{\tau_{a}}_{a\in A}, s_{0}, \sim}
      \text{ with }
      \mathcal{O} = \set{\interval{s}_{\sim}: s\in S}
      \text{ and }
      \mathcal{P} = \tuple{Q, S, \delta, q_{0}, F}
    \end{equation*} 
    we construct the choiceless \ac{WDTA}
    \begin{equation*}
      \mathcal{A}_{\mathcal{M}}^{\mathcal{P}} = \tuple{
        S\times Q, \tuple{s_{0}, q_{0}}, A, \mathcal{O}, \Delta, S\times F
      }.
    \end{equation*}
    The transitions in $\Delta$ are of the form
    \begin{equation*}
      \tuple{\tuple{s, q}, a, G_{\tuple{s,q}}^{a}}
      \text{ with }
      G_{\tuple{s,q}}^{a}(\tuple{z,p}, o) = \begin{cases}
        \tau_{a}(s, z)\cdot\delta(q, z, p)&\text{if }\interval{z}_{\sim} = o,\\
        0&\text{otherwise}.
      \end{cases}
    \end{equation*}
  \end{definition}
  Notably, again all trees for this \ac{WDTA} 
  $\mathcal{A}_{\mathcal{M}}^{\mathcal{P}}$ are valid strategies for the 
  \ac{POMDP} $\mathcal{M}$. We fix one tree (or strategie respectively) $s$. 
  For the unique run $r$ of $\mathcal{A}_{\mathcal{M}}^{\mathcal{P}}$ on $s$ we
  can observe (analogously to the construction for Theorem 
  \ref{thm:POMDPequivWDTA}) that the $S$ component of any state uniquely 
  correlates to one $\mathcal{O}$ component and by the definition of 
  $G_{\tuple{s, q}}^{a}$ this is the only direction weight can be passed to.
  Therefore, we restrict our arguments on the weighted part of the domain of
  $r$, namely $\tuple{S\times Q}^{*}$. By definition of the transitions we 
  obtain for any word 
  $\tuple{s_{0}, q_{0}}\dots\tuple{s_{n}, q_{n}}\in\tuple{S\times Q}^{*}$
  \begin{align*}
    \mu_{r}(\tuple{s_{1}, q_{1}}\dots\tuple{s_{n}, q_{n}}) &= 
      G^{s(\epsilon)}(\tuple{s_{1}, q_{1}})\cdot 
      \prod\limits_{i = 1}^{n-1}
        G^{s(\interval{s_{1}\dots s_{n}}_{\sim})}_{\tuple{s_{i}, q_{i}}}(
          s_{i+1}, q_{i+1})\\
    &= \delta(q_{0}, s_{1}, q_{1})\cdot\tau_{s(\epsilon)}(s_{0}, s_{1})
      \prod\limits_{i = 1}^{n-1}
        \delta(q_{i}, s_{i+1}, q_{i+1})\cdot
        \tau_{s(\interval{s_{1}\dots s_{n}}_{\sim})}(s_{i}, s_{i+1})\\
    &= \mu_{s_{1}\dots s_{n}}(\cyl(q_{0}\dots q_{n}))\cdot
      \mu_{s}(\cyl(s_{1}\dots s_{n}))\\
    &= \int_{\cyl(s_{1}\dots s_{n})}K(\cdot, \cyl(q_{0}\dots q_{n}))d\mu_{s}.
  \end{align*}
  This suggests by the uniqueness of $\mu_{s}\otimes K$ and 
  $\mu_{r}$ that these coincide (under renaming of the arguments). It is left
  to examine this renaming for $\mu_{r}$ since $\mu_{r}$ is defined on 
  $\mathcal{B}(S\times Q)$ while $\mu_{s}\otimes K$ is defined on 
  $\mathcal{B}(S)\times\mathcal{B}(Q)$. Not suprisingly, we have
  \begin{lemma}
    $\mathcal{B}(S\times Q)$ and $\mathcal{B}(S)\times\mathcal{B}(Q)$ are 
    equivalent up to renaming.
  \end{lemma}
  \begin{proof}
    From \cite[Theorem 22.1]{Bauer} we know that 
    $\mathcal{B}(S)\times\mathcal{B}(Q)$ is generated by $\cyl(u)\times\cyl(v)$ 
    for all $u\in S^{*}$ and $v\in Q^{*}$. We show that we may 
    \enquote{balance} these generating sets (cp. Lemma \ref{lem:balancedruns}). 
    W.l.o.g. we assume $\size{u} < \size{v}$. From $m = \size{v} - \size{u}$ we 
    generate the set $E = \set{u\cdot y:y\in S^{m}}$. Since $S$ is finite so is 
    $E$ and we may use the generating sets $\cyl(u')\times\cyl(v)$ for all 
    $u'\in E$ to obtain the same set as $\cyl(u)\times\cyl(v)$. Hence, we may 
    restrict our generating sets to balanced cylindric sets. We may biject 
    tuple $\tuple{s_{1}\dots s_{n}, q_{1}\dots q_{n}}$ to 
    $\tuple{s_{1}, q_{1}}\dots \tuple{s_{n}, q_{n}}$ (even up to infinity) and
    obtain a bijection between the generating sets for $\mathcal{B}(S\times Q)$
    and $\mathcal{B}(S)\times\mathcal{B}(Q)$ which survives the construction of
    all elements in the algebra. This allows us to transform the both algebras
    into each other and additionally shows that $\mu_{s}\otimes K$ indeed
    coincides with $\mu_{r}$.
  \end{proof}
  Concludingly, we can observe for the acceptance meausure of 
  $\mathcal{A}_{\mathcal{M}}^{\mathcal{P}}$ 
  \begin{equation*}
    \mu_{r}(\Acc\interval{Q}(S\times F))  
    = \mu_{s}\otimes K(S^{\omega}, \Acc(F))
    = \int_{\alpha\in S^{\omega}}\mu_{\alpha}(\Acc(F)) d\mu_{s}.
  \end{equation*}
  This allows us to state that $\mathcal{A}_{\mathcal{M}}^{\mathcal{P}}$ 
  accepts $s$ if and only if $s$ is a solution to the synthesis question for 
  the \ac{POMDP} $\mathcal{M}$ and the \ac{PBA} $\mathcal{P}$. We may use
  Corollary \ref{cor:emptiness} to compute this $s$.
\end{proof}
