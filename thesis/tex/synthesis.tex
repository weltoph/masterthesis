\chapter{Synthesis}
\label{chapter:synthesis}
\fxfatal{explain synthesis problem}

\section{Word Automata}
On the basis of Theorem \ref{thm:POMDPequivWDTA}, i.e. \acp{WDTA} can be used
to capture the structure of \acp{POMDP}, we provide a product construction for
a \ac{WDTA} and a word automaton such that the accepted trees model
strategies which induce a certain measure of the paths of the \ac{POMDP} that
are accepted by the word automaton. This result allows us to formulate already
established synthesis results for \acp{POMDP} in our framework of \acp{WDTA}
and illustrates that \acp{WDTA} allow for decoupling of the \enquote{weigthing}
and \enquote{accepting} aspects of the model.
\begin{theorem}
  For a \ac{POMDP}
  $\mathcal{M} = \tuple{S,A,\tuple{\tau_{a}}_{a\in A},s_{0},\sim}$
  with $\mathcal{O} = \set{\interval{s}_{\sim}:s\in S}$ and a deterministic
  word automaton $\mathcal{A} = \tuple{Q, \Sigma = \tuple{A\times S}, \delta,
  q_{0}, \parity}$ exists a \ac{WDTA} $\mathcal{W}$ with an
  almost-sure (resp.  positive) acceptance measure such that $\mathcal{W}$
  accepts a tree $t$ if and only if $t$ encodes a strategy such that the
  measure of accepted paths by $\mathcal{A}$ of the unrollment of the execution
  of $\mathcal{M}$ under $t$ equals $1$ (resp. is $>0$).
\end{theorem}
\begin{proof}
  The central idea is to define a fitting \ac{WDTA} $\mathcal{W}$ for the
  combination of $\mathcal{M}$ and $\mathcal{A}$. Thus, we introduce
  \begin{definition}
    For a \ac{POMDP} $\mathcal{M}$ and a tree automaton $\mathcal{A}$ with
    \begin{equation*}
      \mathcal{M} = \tuple{S,A,\tuple{\tau_{a}}_{a\in A},s_{0},\sim}
      \text{ and }
      \mathcal{A} = \tuple{Q,\tuple{A\times S},\Delta,q_{0},\parity}
    \end{equation*}
    define
    \begin{equation*}
      \mathcal{W} = \tuple{S\times Q, \tuple{s_{0}, q_{0}}, \mathcal{O}, A,
      \Delta', \parity'}
    \end{equation*}
    where $\Delta'(\tuple{s,q}, a) = \set{G^{s,a}_{q}}$ with
    \begin{equation*}
      G^{s,a}_{q}(o, \tuple{s', p}) = \begin{cases}
        \tau_{a}(s, s')&\text{ if }o = \interval{s'}_{\sim}\text{ and }
        \delta(q,\tuple{a,s}) = p\\
        0&\text{ otherwise}
      \end{cases}
    \end{equation*}
    and
    \begin{equation*}
      \parity'(s,p) = \parity(p).
    \end{equation*}
  \end{definition}
  It remains to show that the accepted language of $\mathcal{W}$ precisely
  consists of those strategies that unroll $\mathcal{M}$ satisfactory to
  $\mathcal{A}$. Therefore, let $t$ be an accepted tree of $\mathcal{W}$ and
  $r$ the corresponding accepting run. By reading $t$ as a tree over the
  directions $\mathcal{O}$ we can argue that $t$ does indeed describe a
  strategy which respects the observations in $\mathcal{M}$. For every path
  $p = \tuple{\tuple{s_{0},q_{0}}, o_{0}}\dots\tuple{\tuple{s_{n},q_{n}}, o_{n}}$
  we can see that
  \begin{description}
    \item[(either)] $q_{0}\dots q_{n}$ is the unique run of $\mathcal{A}$ on
      the path $\tuple{s_{0}, t(o_{0})}\dots\tuple{s_{n},t(o_{0}\dots o_{n})}$
      if $o_{i} = \interval{s_{i}}_{\sim}$
    \item[(or)] $\mu_{r}(\cyl(p)) = 0$
  \end{description}
  by definition of the transitions of $\mathcal{W}$. Note that these cases are
  not mutually exclusive, since a certain valid execution (in terms of
  $\mathcal{A}$) still can be impossible by the choices of the player and the
  transitions of $\mathcal{M}$. If $p$ does indeed describe a run of
  $\mathcal{A}$ on $\tuple{s_{0}, t(o_{0})}\dots\tuple{s_{n},t(o_{0}\dots o_{n})}$
  we can see that
  $\mu_{r}(\cyl(p)) = \mu_{t}^{\mathcal{M}}(\cyl(s_{0}\dots s_{n}))$ since the
  transition probabilities coincide with
  $\prod_{0\leq i\leq n-1}\tau_{a_{i}}(s_{i}, s_{i+1})$.
  Furthermore by choice of $\parity'$ the set of accepted paths in $r$ are
  those which are accepted paths in $\mathcal{A}$. Hence, we obtain that the
  unique run of $\mathcal{W}$ on any $t$ does indeed induce the measure on the
  accepted paths that coincide with the probability of the execution of these
  paths in $\mathcal{M}$ under strategy $t$.

  The opposite direction follows by similar arguments. Any strategy $t$ that
  respects the observations in $\mathcal{M}$ can be interpreted as a tree with
  directions $\mathcal{O}$ and thus is a viable input for $\mathcal{W}$. Also,
  any such strategy induces on the set of every prolongation of a path
  $s_{0}\dots s_{n}$ the probability
  $\prod_{0\leq i\leq n-1}\tau_{
    t(\interval{s_{0}}_{\sim}\dots\interval{s_{i}}_{\sim})}(s_{i}, s_{i+1})$.
  Also, there is one unique run $q_{0}\dots q_{n}$ on the word
  $\tuple{s_{0},t(\interval{s_{0}}_{\sim})}\dots
   \tuple{s_{n},t(\interval{s_{0}}_{\sim}\dots\interval{s_{n}}_{\sim})}$ by
  $\mathcal{A}$ and the run $r$ of $\mathcal{W}$ on $t$ yields by definition of
  its generators the same measure for $\mu_{r}(\cyl(\tuple{\tuple{s_{0},q_{0}},
  o_{0}}\dots\tuple{\tuple{s_{n},q_{n}}, o_{n}}))$ where
  $o_{i}= \interval{s_{i}}_{\sim}$ as $t$ induces for $s_{0}\dots s_{n}$ in
  $\mathcal{M}$.
\end{proof}
This allows for formulation of some synthesis questions regarding \acp{POMDP},
e.g. synthesis for any LTL-formula, uniform-\ac{PBA},\dots.

\section{Probabilitic BÃ¼chi Automata}
The synthesis for \acp{PBA} is - in our current context - understood as the
following question:
\begin{definition}[PBA-Synthesis Question]
  For a given \ac{MDP} $\mathcal{M}$ where the actions are a finite set $O$ and
  a \ac{PBA} $\mathcal{A}$ over the alphabet $S_{\mathcal{M}}\times O$ we want
  to find a strategy that generates for every history
  $\tuple{s_{0}, o_{0}}\dots\tuple{s_{n-1},o_{n-1}}s_{n}$ an
  $o_{n}$ such that almost-all generated executions are accepted by
  $\mathcal{P}$.
  \label{def:synthesis}
\end{definition}
Considering a qualitative acceptance condition on $\mathcal{A}$ we can answer
this question positively with
\fxwarning{can this be strengthened to POMDPs?}
\begin{theorem}[Qualitative PBA Synthesis]
  The synthesis question of an environment $\mathcal{M}$ and a specification
  provided as \ac{PBA} $\mathcal{A}$ with a qualitative acceptance condition
  can be decided.
  \label{thm:synthesis}
\end{theorem}
Considering a certain restricted class of \acp{MDP}, namely those where every
state has exaclty two following states which are equally likeable to be chosen,
this result can be derived as a corollary from
\cite[Proposition 43]{RandAutoInfTrees}. Naturally, the following proof bears
conceptual similarities to the proof of this Proposition, e.g. by examining an
integratable function within the product space which models the acceptance of
every execution of the environment by the specification. But our setting allows
for a less restricted environment.
\begin{proof}
We substantiate this claim by providing a construction of a \ac{WDTA} from the
given environment and the specification \ac{PBA}. The obtained \ac{WDTA} - with
a qualitative acceptance measure - accepts precisely those trees that encode a
strategy as required by the synthesis question.
Starting with a strategy $t$ we consider two measure spaces, namely the space
of executions in the \ac{MDP} modelling the environment induced by the strategy
$t$ and the space of the executions of the \ac{PBA} modelling the
specification moving along one execution and using the strategy $t$.
Thus, we get $\mu^{\mathcal{M}}_{t}$ as a measure on the $\sigma$-algebra
$\mathcal{F}_{\mathcal{M}}$ which is induced by the set of cylinders in
$S_{\mathcal{M}}$. And, we get $\mu^{\mathcal{P}}_{t}$ as a measure on the
$\sigma$-algebra $\mathcal{F}_{\mathcal{P}}$ which is induced
by the set of cylinders in $S_{\mathcal{M}}\times Q_{\mathcal{P}}$. The
semantic of $\mu^{\mathcal{P}}_{t}$ is a merging of runs of
$\mathcal{P}$ on all executions of the environment, i.e. we set
$\mu^{\mathcal{P}}_{t}(\cyl(\tuple{s_{1}, q_{1}}\dots\tuple{s_{n}, q_{n}}))$
as the probability that for the prefix $s_{1}\dots s_{n}$ $\mathcal{P}$
moves along $q_{1}\dots q_{n}$. The product-algebra for these measures is
by \cite[Theorem 22.1]{Bauer} generated by the product of generating sets of
the individual $\sigma$-algebras. Thus, we can understand the product-algebra
$\mathcal{F}$ as the one generated by the product of cylinders over
$S_{\mathcal{M}}$ and $S_{\mathcal{M}}\times Q_{\mathcal{P}}$, i.e. for all
$u\in \tuple{S_{\mathcal{M}}}^{*}$ and
$v\in \tuple{S_{\mathcal{M}}\times Q_{\mathcal{P}}}^{*}$ the sets in
$\cyl(u)\times\cyl(v)$. As suggested in \cite[Remark 35]{RandAutoInfTrees}
these generating cylinders can be \enquote{balanced}.
\begin{lemma}[Balanced Cylinders]
  The $\sigma$-algebra induced by generating sets $\cyl(u)\times\cyl(v)$ with
  $u\in \tuple{S_{\mathcal{M}}}^{n}$ and
  $v\in \tuple{S_{\mathcal{M}}\times Q_{\mathcal{P}}}^{n}$ for all
  $n\in\mathbb{N}$ coincides with $\mathcal{F}$.
  \label{lem:balanced}
\end{lemma}
\begin{proof}
  Since all balanced generators are included in the generators of $\mathcal{F}$
  it is clear that the balanced generators cannot yield a more complex algebra.
  On the other hand we consider arbitrary $u\in \tuple{S_{\mathcal{M}}}^{*}$
  and $v\in \tuple{S_{\mathcal{M}}\times Q_{\mathcal{P}}}^{*}$ and w.l.o.g.
  assume $\size{u}<\size{v}$. There are only finitely many prolongations of $u$
  to the length of $v$ in $S_{\mathcal{M}}$. Let $\set{u_{1},\dots,u_{k}}$ be
  these prolongations. The union of products of $\cyl(v)$ with $\cyl(u_{i})$
  for $1\leq i\leq k$ coincides with the product of $\cyl(v)$ with $\cyl(u)$.
  Thus, balanced generators include all unbalanced generators rendering the
  generated algebras equal.
\end{proof}
Additionally, we can \enquote{deconstruct} the interleaving of elements in
$\tuple{S_{\mathcal{M}}\times Q_{\mathcal{P}}}^{\omega}$ by mapping an element
$\tuple{s_{1},q_{1}}\tuple{s_{2},q_{2}}\dots$ to
$\tuple{s_{1}s_{2}\dots,q_{1}q_{2}\dots}\in
\tuple{S_{\mathcal{M}}}^{\omega}\times\tuple{Q_{\mathcal{P}}}^{\omega}$. This
mapping is obviously a bijection and thus, we occasionally use these notions
interchangeably. For example in the following function
$f:\tuple{\tuple{S_{\mathcal{M}}}^{\omega}\times
\tuple{Q_{\mathcal{P}}}^{\omega}}\times\tuple{S_{\mathcal{M}}}^{\omega}
\rightarrow\set{0,1}$ with
\begin{equation*}
  f(\tuple{\alpha,\beta},\gamma) =
  \begin{cases}
    1&\text{ if }\alpha = \gamma\text{ and }\beta
    \text{ satisfies the BÃ¼chi condition of }\mathcal{P}\\
    0&\text{ otherwise}
  \end{cases}
\end{equation*}
which models precisely the acceptance of executions of the environment by the
specification. We note that the measureability of $f$ is shown analogously to
Lemma \ref{lem:measureabilityAcceptance}.
\begin{lemma}
  $f$ is a measureable function w.r.t. the $\sigma$-algebra $\mathcal{F}$.
\end{lemma}
\begin{proof}
  We show that $f^{-1}(1)$ is measurable in $\mathcal{F}$. Therefore, we fix
  for every $w = s_{1}\dots s_{n}\in \tuple{S_{\mathcal{M}}}^{*}$ the set of
  all prolongation of this synchronised prefix
  \begin{equation*}
    \Syn(w) = \bigcup_{v = q_{1}\dots q_{n}}\cyl(\tuple{s_{1},q_{1}}\dots
    \tuple{s_{n},q_{n}})\times\cyl(w)
  \end{equation*}
  This allows us to define the set of all synchronised paths by
  \begin{equation*}
    \bigcap_{n>0}\bigcup_{w\in \tuple{S_{\mathcal{M}}}^{n}}\Syn(w)
  \end{equation*}
  because if a path is unsynchronised it is not included after the length at
  which the first diversion appears. On the other hand we can assure that every
  synchronised path is present in every inner union and thus in the outer
  intersection. Adapting the proof of Lemma \ref{lem:measureabilityAcceptance}
  for BÃ¼chi condition yields that the set of those paths that satisfy the BÃ¼chi
  condition under projection to the state component is measurable. $f^{-1}(1)$
  can be obtained as the intersection of the synchronised paths and those
  path which state component satisfies the BÃ¼chi condition rendering it
  measureable.
\end{proof}
Thus, $f$ is the indicator-function of a measureable set and therefore
integrable. Examining the integral of $f$ yields interesting results. Most
notably for one fixed execution $\alpha\in S_{\mathcal{M}}^{\omega}$ we can
argue that $\int_{\tuple{\beta,\gamma}\in
\tuple{Q_{\mathcal{P}}}^{\omega}\times\tuple{S_{\mathcal{M}}}^{\omega}}
f(\tuple{\beta,\gamma},\alpha)$ is precisely the measure of accepted paths for
the specification-\ac{PBA} regarding this execution. Let
$P_{\alpha} = \set{\tuple{\alpha, \beta}:\beta\in
\tuple{Q_{\mathcal{P}}}^{\omega}}$ and by definition $f(q, \alpha) = 0$ for all
$q\not\in P_{\alpha}$. Hence
\begin{equation*}
  \int\limits_{\tuple{\beta,\gamma}\in
  \tuple{Q_{\mathcal{P}}}^{\omega}\times\tuple{S_{\mathcal{M}}}^{\omega}}
  f(\tuple{\beta,\gamma},\alpha)d\mu_{\mathcal{P}}^{t}
  =\int\limits_{\tuple{\beta,\alpha}\in P_{\alpha}}
  f(\tuple{\beta,\alpha},\alpha)d\mu_{\mathcal{P}}^{t}
  =\int\limits_{\beta\in\tuple{Q_{\mathcal{P}}}^{\omega}}
  f(\tuple{\beta,\alpha},\alpha)d\mu_{\mathcal{P}}^{t}
\end{equation*}
and since the first and third component are synchronised $f$ is the indicator
function of those words in $\tuple{Q_{\mathcal{P}}}^{\omega}$ which satisfy the
attached BÃ¼chi condition (gathered in set $\mathcal{F}$), thus
\begin{equation*}
  \int\limits_{\beta\in\tuple{Q_{\mathcal{P}}}^{\omega}}
  f(\tuple{\beta,\alpha},\alpha)d\mu_{\mathcal{P}}^{t}
  = \mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F})
\end{equation*}
where $\mu_{\mathcal{P}}^{t,\alpha}$ describes the probability measure of
states in $\mathcal{P}$ on path $\alpha$. This concludingly gives with
Tonelli's Theorem (see \cite[Theorem 23.6]{Bauer})
\begin{equation*}
  \int f d(\mu_{\mathcal{M}}^{t}\otimes\mu_{\mathcal{P}}^{t}) =
  \int\int f d(\mu_{\mathcal{P}}^{t})d(\mu_{\mathcal{M}}^{t}) =
  \int_{\alpha}\mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F})d(\mu_{\mathcal{M}}^{t})
\end{equation*}
and $\int_{\alpha}\mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F})
d(\mu_{\mathcal{M}}^{t}) = 1$ if and only if
$\mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F}) = 1$ almost everywhere by
\cite[Lemma 40]{RandAutoInfTrees} which in turn characterises precisely the
synthesis question provided in Definition \ref{def:synthesis}.

To conclude the proof for Theorem \ref{thm:synthesis} we provide a definition
of a \ac{WDTA} for a given environment-\ac{MDP} $\mathcal{M}$ and a
specification-\ac{PBA} $\mathcal{P}$ which precisely models the defined
function $f$ from above with its acceptance condition.
\begin{definition}[Synthesis WDTA]
  For a \ac{MDP} $\mathcal{M} = \tuple{S, O, \tuple{\tau_{o}}_{o\in O},
  \iota_{0}}$ and a \ac{PBA} $\mathcal{P} = \tuple{Q, S\times O, \delta, q_{0},
  F}$ we construct the \ac{WDTA}
  $\mathcal{A} = \tuple{S\times Q\uplus\set{s_{0}}, s_{0}, S, O, \Delta,
  T}$ with $\Delta(s_{0}, \sigma) = \set{G_{0}}$ where
  \begin{equation*}
    G_{0}(\tuple{s,q}, s') =
    \begin{cases}
      \iota_{0}(s)&\text{ if }s = s'\text{ and }q = q_{0}\\
      0 &\text{ otherwise}
    \end{cases}
  \end{equation*}
  and $\Delta(\tuple{s, q}, \sigma) = \set{G^{s}_{\sigma}}$ where
  \begin{equation*}
    G^{s}_{\sigma}(\tuple{z,p}, z') =
    \begin{cases}
      \delta(q, \tuple{s,\sigma}, p)\cdot\tau_{\sigma}(s,z)&\text{ if }z = z'\\
      0 &\text{ otherwise}
    \end{cases}
  \end{equation*}
  Furthermore we define $T$ as a BÃ¼chi condition with $T = S\times F$, i.e. the
  original BÃ¼chi condition projected to the second component of the
  states in $\mathcal{A}$.
\end{definition}
Examining the unique run of $\mathcal{A}$ on a tree $t$ therefore yields a
probability distribution upon the $\sigma$-algebra induced by the cylinders
over the set $\tuple{\tuple{S_{\mathcal{M}}\times Q_{\mathcal{P}}}\times
S_{\mathcal{M}}}$. Recall that the product algebra of
$\mu_{\mathcal{M}}^{t}$ and $\mu_{\mathcal{P}}^{t}$ is defined by the product
of the sets $\cyl(u)$ and $\cyl(v)$ for all $u\in\tuple{S_{\mathcal{M}}}^{*}$
and $v\in\tuple{Q_{\mathcal{P}}\times S_{\mathcal{M}}}^{*}$. Examining the
sub-algebra of \enquote{synchronised} paths, i.e. the trace-algebra of
\begin{equation*}
  \set{\tuple{\alpha,\beta}\in \tuple{S_{\mathcal{M}}}^{\omega}\times
  \tuple{Q_{\mathcal{P}}\times S_{\mathcal{M}}}^{\omega}\mid\text{ with }
  \beta = \tuple{q_{1}, s_{1}}\tuple{q_{2}, s_{2}}\dots\text{ and }
  s_{1}s_{2}\dots = \alpha}
\end{equation*}
we obtain the equality to the measure induced by the run of $\mathcal{A}$ on
$t$ to the product measure on the synchronised part of the product algebra.
\begin{lemma}
  The measure $\mu_{r}$ of the unique run $r$ of $\mathcal{A}$ on $t$ coincides
  with $\mu_{\mathcal{M}}^{t}\otimes\mu_{\mathcal{P}}^{t}$ on the synchronised
  part of the product algebra.
  \label{lem:productmeasure}
\end{lemma}
\begin{proof}
  By Lemma \ref{lem:balanced} it is sufficient to examine balanced generators
  and thus, fix $n\in\mathbb{N}$ and $s_{1}\dots s_{n}
  \in\tuple{S_{\mathcal{M}}}^{n},
  q_{1}\dots q_{n}\in\tuple{Q_{\mathcal{P}}}^{n}$. By definition of
  $\mathcal{A}$ we obtain
  \begin{align*}
    \mu_{r}&(\cyl(s_{0}\tuple{\tuple{s_{1},q_{1}}, s_{1}}\dots\tuple{\tuple{s_{n},q_{n}}, s_{n}}))\\
    &= G_{0}(\tuple{\tuple{s_{1},q_{1}}, s_{1}})\cdot\prod\limits_{i = 1}^{n-1}
    G^{s_{i}}_{t(s_{1}\dots s_{i})}(\tuple{\tuple{s_{i+1},q_{i+1}}, s_{i+1}}))\\
    &=\iota_{0}(s_{1})\cdot\prod\limits_{i = 1}^{n-1}
    \tau_{t(s_{1}\dots s_{i})}(s_{i}, s_{i+1})\cdot
    \delta(q_{i}, \tuple{s_{i}, t(s_{1}\dots s_{i})}, q_{i+1})\\
    &=\iota_{0}(s_{1})\cdot\prod\limits_{i = 1}^{n-1}\tuple{
      \tau_{t(s_{1}\dots s_{i})}(s_{i}, s_{i+1})}
    \cdot\prod\limits_{i = 1}^{n-1}\tuple{
      \delta(q_{i}, \tuple{s_{i}, t(s_{1}\dots s_{i})}, q_{i+1})}\\
    &=\mu_{\mathcal{M}}^{t}(\cyl(s_{1}\dots s_{n}))\cdot
      \mu_{\mathcal{P}}^{t}(\cyl(\tuple{q_{1},s_{1}}\dots\tuple{q_{n},s_{n}}))
  \end{align*}
  and thus, by unique extension of $\mu_{r}$ and uniqueness of the product
  measure \cite[Theorem 5.6, Theorem 22.2]{Bauer} follows the claimed equality.
\end{proof}
Furthermore, by definition of $f$ we obtain that $f^{-1}(\set{1})$ is the set
of all paths in the synchronised part of the product algebra where the state
component satisfies the BÃ¼chi condition and therefore
\begin{equation*}
  \int_{\alpha}\mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F})
  d(\mu_{\mathcal{M}}^{t}) = \mu_{r}(\mathcal{T})
\end{equation*}
where $\mathcal{T}$ is the set of all paths in $r$ satisfying the BÃ¼chi
condition imposed by $T_{\mathcal{A}}$. This implies that
\begin{equation*}
  \int_{\alpha}\mu_{\mathcal{P}}^{t,\alpha}(\mathcal{F})
  d(\mu_{\mathcal{M}}^{t}) = 1\text{ if and only if }\mathcal{A}
  \text{ accepts } t
\end{equation*}
and hence Theorem \ref{thm:synthesis} follows from the possibility to check
emptiness of $\mathcal{A}$ (by Corollary \ref{cor:emptiness}).
\end{proof}
