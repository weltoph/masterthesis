\chapter{Synthesis}
\label{chapter:synthesis}
\fxfatal{explain synthesis problem}
\section{Probabilitic B端chi Automata}
The synthesis for \acp{PBA} is - in our current context - understood as the
following question:
\begin{definition}[PBA-Synthesis Question]
  For a given \ac{MDP} $\mathcal{M}$ where the actions are a finite set $O$ and
  a \ac{PBA} $\mathcal{A}$ over the alphabet $S_{\mathcal{M}}\times O$ we want
  to find a strategy that generates for every history
  $\tuple{s_{0}, o_{0}}\dots\tuple{s_{n-1},o_{n-1}}s_{n}$ an
  $o_{n}$ such that the measure induced by the probability of projection to the
  first component induced by $\mathcal{M}$ $\mu$ of those words that lay within
  $L(\mathcal{A})$ is 1.
\end{definition}
Considering a qualitative acceptance condition on $\mathcal{A}$ we can answer
this question positively with
\begin{theorem}[Qualitative PBA Synthesis]
  The synthesis question of an environment $\mathcal{M}$ and a specification
  provided as \ac{PBA} $\mathcal{A}$ with a qualitative acceptance condition
  can be decided.
\end{theorem}
We substantiate this claim by providing a construction of a \ac{WDTA} from the
given environment and the specification \ac{PBA}. The obtained \ac{WDTA} - with
a qualitative acceptance measure - accepts precisely those trees that encode a
strategy as required by the synthesis question.
\begin{definition}[Synthesis WDTA]
  For a \ac{MDP} $\mathcal{M} = \tuple{S, O, \tuple{\tau_{o}}_{o\in O},
  \iota_{0}}$ and a \ac{PBA} $\mathcal{P} = \tuple{Q, S\times O, \delta, q_{0},
  F}$ we construct the \ac{WDTA}
  $\mathcal{A} = \tuple{S\times Q\uplus\set{s_{0}}, s_{0}, S, O, \Delta,
  T}$ with $\Delta(s_{0}, \sigma) = \set{G_{0}}$ where
  \begin{equation*}
    G_{0}(\tuple{s,q}, s') =
    \begin{cases}
      \iota_{0}(s)&\text{ if }s = s'\text{ and }q = q_{0}\\
      0 &\text{ otherwise}
    \end{cases}
  \end{equation*}
  and $\Delta(\tuple{s, q}, \sigma) = \set{G^{s}_{\sigma}}$ where
  \begin{equation*}
    G^{s}_{\sigma}(\tuple{z,p}, z') =
    \begin{cases}
      \delta(q, \tuple{s,\sigma}, p)\cdot\tau_{\sigma}(s,z)&\text{ if }z = z'\\
      0 &\text{ otherwise}
    \end{cases}
  \end{equation*}
  Furthermore we define $T$ as a B端chi condition with $T = S\times F$, i.e. the
  original B端chi condition projected to the second component of the
  states in $\mathcal{A}$.
\end{definition}
The proof mainly follows ideas from \cite[Proposition 43]{RandAutoInfTrees}.
\fxfatal{Current proof is utterly wrong since alpha depends on M; we can fix
this by defining the probability space for the PBA over a tree and
directions x states, then the directions yield a word and the states are the
runtree-probability on that word; this way we can salvage most of this proof}
First of all, we observe that $\mathcal{A}$ is deterministic. And secondly, we
have - given a strategy $\varphi_{\mathcal{M}}$ for the environment - a
probability distribution $\mu_{\varphi_{\mathcal{M}}}$ over the
$\sigma$-algebra that is induced by the cylinders over $S_{\mathcal{M}}$.
Furthermore, we can obtain for every word
$\alpha\in\tuple{S_{\mathcal{M}}\times O}^{\omega}$ a probability distribution
$\mu_{\alpha}$ over the $\sigma$-algebra that is induced by the cylinders over
$Q$. Now, we argue that the run of $\mathcal{A}$ does precisely model the
product distribution of these two probability distributions if the underlying
tree is understood as strategy for the environment. Since $\mathcal{A}$ runs on
trees of the form $t:S_{\mathcal{M}}^{*}\rightarrow O$ they can be directly
understood as strategies for $\mathcal{M}$. Also, such a $t$ induces an
infinite word on $S_{\mathcal{M}}\times O$ by
$s_{1}t(s_{1})s_{2}t(s_{1}s_{2})\dots$. This cummulates into
\begin{lemma}[Product Measure PBA]
  The unique run of $\mathcal{A}$ on a tree $t$ induces a probability measure
  $\lambda$ on the $\sigma$-algebra induced by the cylinders over
  $S_{\mathcal{M}}\times Q$ which is equivalent to the product measure
  $\mu_{\varphi_{t}}\otimes \mu_{\alpha}$.
  \label{lem:productmeasure}
\end{lemma}
\begin{proof}
  This proof separates into two parts: on the one hand we show the equivalence
  of the $\sigma$-algebras and on the other hand we show that the measures on
  the generating sets of cylinders agree which then yields the claimed
  equivalence.
\item [Algebras:]
  The generating sets of the $\sigma$-algebra induced by the run $r$ of
  $\mathcal{A}$ on $t$ are cylinders over the set
  $\tuple{\tuple{S_{\mathcal{M}}\times Q}\times S_{\mathcal{M}}}$ while the
  $\sigma$-algebra of the product space is generated by the products of all
  generating sets of the individual generating sets, i.e. for all
  $u\in S_{\mathcal{M}}^{*}$ and $v\in Q^{*}$ the product of $\cyl(u)$ and
  $\cyl(v)$. First of all, balance the length of the generating prefixes $u, v$
  without changing the generated $\sigma$-algebra: we claim to obtain the
  product algebra if we only take for every $n$ and $u\in S_{\mathcal{M}}^{n}$,
  $v\in Q^{n}$ the product of $\cyl(u)$ and $\cyl(v)$ (analogous to
  \cite[Remark 35]{RandAutoInfTrees}). Fix two arbitrary
  $u\in S_{\mathcal{M}}^{*}$, $v\in Q^{*}$ and assume w.l.o.g.
  $\size{u} > \size{v}$. There are finitely many possibilities to prolong $v$
  in $Q$ to the length $\size{u}$.  Let $v_{1},\dots, v_{n}$ be these
  prolongations. The union of the products of $\cyl(u)$ and $\cyl(v_{i})$ for
  $1\leq i\leq n$ are part of the generating sets and thus their union is part
  of the generated $\sigma$-algebra which yields that all generating sets of
  the product algebra are part of the balanced generators. Additionally, the
  set of all \enquote{unbalanced} products contains all \enquote{balanced}
  products which gives the claimed equality of the generated $\sigma$-algebras.
\item [Measures:] Foremost, we note that technically the run induces a measure
  over the $\sigma$-algebra induced by the cylinders over
  $\tuple{\tuple{S_{\mathcal{M}}\times Q}\times S_{\mathcal{M}}}$. But by
  examining the distributions $G_{0}$ and $G^{s}_{\sigma}$ for all
  $s\in S_{\mathcal{M}}$ and $\sigma\in O$ we can see that any cylinder where
  the two occurences of states of $\mathcal{M}$ diverge are immediately
  discarded, i.e. set to $0$. We can therefore restrict our attention to those
  cylinders over $S_{\mathcal{M}}\times Q$. Additionally, we note that we can
  biject those cylinders over $S_{\mathcal{M}}\times O$ to the products of
  cylinders over $S_{\mathcal{M}}$ and $O$ by resolve the interleaving of the
  letters. By \cite[Theorem 22.2]{Bauer} it suffices to show that the induced
  measure of the run and the product measure agree on the generating sets.
  Thus, we show that for every $n$ and all $u\in S_{\mathcal{M}}^{n},
  v\in Q^{n}$ we have $\lambda(\cyl(s_{0}u_{1}v_{1}\dots u_{n}v_{n})) =
  \mu_{\varphi_{t}}(u)\cdot\mu_{\alpha}(v)$ and obtain the Lemma. The run
  induces
  \begin{alignat*}{4}
    \lambda(\cyl(s_{0}u_{1}v_{1}\dots u_{n}v_{n})) &=&
    &G_{0}(u_{1}v_{1})&&\cdot\prod\limits_{i = 1}^{n-1}
    G^{u_{i}}_{t(u_{1}\dots u_{i})}(u_{i+1}, v_{i+1})&&\\
    &=&&\iota_{0}(u_{1})&&\cdot\prod\limits_{i = 1}^{n-1}
    \tau_{t(u_{1}\dots u_{i})}(u_{i}, u_{i+1})&&\cdot
    \delta(v_{i}, \tuple{u_{i}, t(u_{1}\dots u_{i})}, v_{i+1})\\
    &=&&\iota_{0}(u_{1})&&\cdot\prod\limits_{i = 1}^{n-1}\tuple{
      \tau_{t(u_{1}\dots u_{i})}(u_{i}, u_{i+1})}
    &&\cdot\prod\limits_{i = 1}^{n-1}\tuple{
      \delta(v_{i}, \tuple{u_{i}, t(u_{1}\dots u_{i})}, v_{i+1})}\\
    &=&&&&\mu_{\varphi_{t}}(u)&&\cdot\mu_{\alpha}(v)
  \end{alignat*}
  which yields the claim.
\end{proof}
As a second step we show that the acceptance condition for a run in
$\mathcal{A}$ is fulfilled if and only if the associated strategy of a tree
only allows for a 0-set of branches to not be in the language of the
specification $\mathcal{P}$.
\begin{lemma}[Acceptance Measure]
  Let $t$ be a tree. $\mathcal{A}$ accepts $t$ if and only if the set of
  executions in $\mathcal{M}$ under $t$ that does not satisfy $\mathcal{P}$ is
  a 0-set.
\end{lemma}
\begin{proof}
  Lemma \ref{lem:productmeasure} yields that the unique run of $\mathcal{A}$ on
  $t$ induces a measure $\lambda$ which is equivalent to the product measure of
  $\mu_{\varphi_{t}}\otimes\mu_{\alpha}$. Let $M$ be the set of paths that does
  not satisfy $\mathcal{P}$ and let $\mathcal{F}\subseteq Q^{\omega}$ be the
  set of paths in $Q$ that satisfy the associated B端chi condition $F$ in
  $\mathcal{P}$. By Tonelli's Theorem \cite[Theorem 23.6]{Bauer} we get that
  \begin{equation*}
    \lambda(\overline{T}) = \int\limits_{\overline{T}}\mathbbm{1}d\lambda =
    \int\limits_{S_{\mathcal{M}}^{\omega}}\int\limits_{\overline{\mathcal{F}}}
    \mathbbm{1}d\mu_{\alpha}d\mu_{\varphi_{t}} =
    \int\limits_{M}\int\limits_{\overline{\mathcal{F}}}
    \mathbbm{1}d\mu_{\alpha}d\mu_{\varphi_{t}} +
    \int\limits_{\overline{M}}\int\limits_{\overline{\mathcal{F}}}
    \mathbbm{1}d\mu_{\alpha}d\mu_{\varphi_{t}}
  \end{equation*}
  Thus, by the definition of $M$ we know that
  \begin{equation*}
    \int\limits_{\overline{M}}\int\limits_{\overline{\mathcal{F}}}\mathbbm{1}d\mu_{\alpha}d\mu_{\varphi_{t}}
    =\int\limits_{\overline{M}} \underbrace{\mu_{\alpha}(\overline{\mathcal{F}})}_{=0}d\mu_{\varphi_{t}}
  \end{equation*}
  Hence $\lambda(\overline{T}) > 0$ if and only if
  $\int_{M}\int_{\overline{\mathcal{F}}}\mathbbm{1}d\mu_{\alpha}
  d\mu_{\varphi_{t}} > 0$ which yields the required equality immediately.
\end{proof}
